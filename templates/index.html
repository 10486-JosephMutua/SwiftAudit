<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SwiftAudit â€” AI Security Platform</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- React 18 (production) -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

<!-- Babel standalone (JSX transpiler) -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Fonts: DM Mono (data/code) + Outfit (display/headings) -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: {
        mono:    ['DM Mono', 'monospace'],
        display: ['Outfit', 'sans-serif'],
      },
      colors: {
        ink:    '#07090e',
        pit:    '#0b0e16',
        well:   '#111520',
        card:   '#161c28',
        rim:    '#1e2638',
        fence:  '#28334a',
        ash:    '#4a5568',
        fog:    '#8492a6',
        mist:   '#b8c4d4',
        snow:   '#e8eef8',
        /* accents */
        lime:   '#4ade80',
        cyan:   '#22d3ee',
        sky:    '#60a5fa',
        mauve:  '#c084fc',
        gold:   '#fbbf24',
        coral:  '#f87171',
      },
    },
  },
};
</script>

<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html, body { 
    height: 100vh; 
    width: 100vw;
    overflow: hidden; /* Prevents whole page scrolling */
  }

  body {
    background: #07090e;
    color: #b8c4d4;
    font-family: 'DM Mono', monospace;
    -webkit-font-smoothing: antialiased;
  }

  /* â”€â”€ scrollbar â”€â”€ */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: #0b0e16; }
  ::-webkit-scrollbar-thumb { background: #28334a; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #4a5568; }

  /* â”€â”€ noise overlay â”€â”€ */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9999;
    opacity: .028;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)'/%3E%3C/svg%3E");
  }

  /* â”€â”€ grid â”€â”€ */
  .grid-bg {
    background-image:
      linear-gradient(rgba(34,211,238,.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(34,211,238,.04) 1px, transparent 1px);
    background-size: 48px 48px;
  }

  /* â”€â”€ orbs â”€â”€ */
  .orb { position: fixed; border-radius: 50%; pointer-events: none; filter: blur(2px); }

  /* â”€â”€ cta gradient button â”€â”€ */
  .btn-glow {
    background: linear-gradient(120deg, #22d3ee, #4ade80, #22d3ee);
    background-size: 200% auto;
    animation: btnShimmer 3s linear infinite;
    color: #07090e;
    font-family: 'Outfit', sans-serif;
    font-weight: 800;
    letter-spacing: .02em;
  }
  @keyframes btnShimmer { to { background-position: -200% center; } }

  /* â”€â”€ spinner â”€â”€ */
  .spinner {
    border: 2px solid rgba(34,211,238,.2);
    border-top-color: #22d3ee;
    border-radius: 50%;
    animation: spin .6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ pulse dots â”€â”€ */
  @keyframes blink {
    0%, 100% { opacity: .2; transform: scale(1); }
    50%       { opacity: 1;  transform: scale(1.4); }
  }

  /* â”€â”€ slide-up entrance â”€â”€ */
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(14px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .anim-up { animation: slideUp .32s ease-out both; }

  /* â”€â”€ fade in â”€â”€ */
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .anim-fade { animation: fadeIn .22s ease-out both; }

  /* â”€â”€ slide in from left â”€â”€ */
  @keyframes slideLeft {
    from { opacity: 0; transform: translateX(-10px); }
    to   { opacity: 1; transform: translateX(0); }
  }
  .anim-left { animation: slideLeft .22s ease-out both; }

  /* â”€â”€ active phase glow â”€â”€ */
  .phase-active {
    box-shadow: 0 0 0 1px rgba(34,211,238,.35), 0 0 18px -3px rgba(34,211,238,.2);
  }

  /* â”€â”€ severity badges â”€â”€ */
  .b-CRITICAL { background: rgba(248,113,113,.12); color: #f87171; border-color: rgba(248,113,113,.4); }
  .b-HIGH     { background: rgba(251,191,36,.10);  color: #fbbf24; border-color: rgba(251,191,36,.35); }
  .b-MEDIUM   { background: rgba(192,132,252,.10); color: #c084fc; border-color: rgba(192,132,252,.35); }
  .b-LOW      { background: rgba(96,165,250,.10);  color: #60a5fa; border-color: rgba(96,165,250,.35); }
  .b-INFO     { background: rgba(74,222,128,.08);  color: #4ade80; border-color: rgba(74,222,128,.3); }

  /* â”€â”€ source labels â”€â”€ */
  .s-snyk_code      { color: #4ade80; }
  .s-trivy          { color: #60a5fa; }
  .s-snyk_iac       { color: #fbbf24; }
  .s-snyk_container { color: #c084fc; }
  .s-history_guard  { color: #22d3ee; }
  .s-llm_only       { color: #8492a6; }
  .s-llm_enriched   { color: #8492a6; }

  /* â”€â”€ finding card hover â”€â”€ */
  .fcard {
    transition: background .14s, border-color .14s, transform .12s;
    cursor: pointer;
  }
  .fcard:hover { background: #1e2638; border-color: #4a5568; transform: translateX(3px); }

  /* â”€â”€ expand/collapse â”€â”€ */
  .expand { display: grid; grid-template-rows: 0fr; transition: grid-template-rows .22s ease; }
  .expand.open { grid-template-rows: 1fr; }
  .expand > div { overflow: hidden; }

  /* â”€â”€ progress bar track â”€â”€ */
  .prog-track { background: #1e2638; border-radius: 4px; overflow: hidden; }
  .prog-fill  {
    height: 100%;
    border-radius: 4px;
    transition: width .7s ease-out;
    position: relative;
    overflow: hidden;
  }
  .prog-fill::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,.25) 50%, transparent 100%);
    animation: shimProg 1.8s linear infinite;
  }
  @keyframes shimProg { from { transform: translateX(-100%); } to { transform: translateX(200%); } }

  /* â”€â”€ terminal â”€â”€ */
  .term { font-size: 11px; line-height: 1.75; }
  .term-scroll { 
    overflow-y: auto; 
    scrollbar-width: thin; 
    scrollbar-color: #28334a #0b0e16; 
  }

  /* â”€â”€ radar chart â”€â”€ */
  .radar-poly { fill: rgba(34,211,238,.12); stroke: #22d3ee; stroke-width: 1.5; }
  .radar-grid { fill: none; stroke: #1e2638; stroke-width: .8; }

  /* â”€â”€ bar chart â”€â”€ */
  .bar-fill { transition: width .8s ease-out; }
</style>
</head>
<body>
<div id="root" class="h-full w-full"></div>

<script type="text/babel">
{% raw %}
  
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMPORTS & HOOKS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const {
  useState, useEffect, useRef,
  useCallback, useMemo, Fragment
} = React;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const API = '/api/v1';

const PHASES = [
  { id:'navigator',  label:'Navigator',    icon:'ğŸ”', note:'Mapping repository' },
  { id:'researcher', label:'Researcher',   icon:'ğŸ”¬', note:'Cloning & scanning'  },
  { id:'scanner',    label:'Scanners',     icon:'ğŸ›¡',  note:'Snyk + Trivy + IAC'  },
  { id:'analysis',   label:'LLM Analysis', icon:'ğŸ§ ', note:'AI vulnerability audit' },
  { id:'exploiter',  label:'Exploiter',    icon:'âš”',  note:'Attack simulation'    },
  { id:'auditor',    label:'Auditor',      icon:'ğŸ“Š', note:'Building report'      },
];

const SEV_RANK  = { CRITICAL:0, HIGH:1, MEDIUM:2, LOW:3, INFO:4 };
const SEV_COLOR = { CRITICAL:'#f87171', HIGH:'#fbbf24', MEDIUM:'#c084fc', LOW:'#60a5fa', INFO:'#4ade80' };
const GRADE_COL = { A:'#4ade80', B:'#60a5fa', C:'#fbbf24', D:'#f87171', F:'#f87171' };

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const cx  = (...a) => a.filter(Boolean).join(' ');
const num = n => (n ?? 0).toLocaleString();
const dur = s => {
  if (!s) return 'â€”';
  return s < 60 ? `${Math.round(s)}s` : `${Math.floor(s/60)}m ${Math.round(s%60)}s`;
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INLINE SVG ICONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Ic = {
  Shield: () => (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
    </svg>
  ),
  Search: () => (
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round">
      <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
    </svg>
  ),
  Check: () => (
    <svg width="11" height="11" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
      <polyline points="20 6 9 17 4 12"/>
    </svg>
  ),
  ChevDown: () => (
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
      <path d="m6 9 6 6 6-6"/>
    </svg>
  ),
  ChevRight: () => (
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
      <path d="m9 18 6-6-6-6"/>
    </svg>
  ),
  File: () => (
    <svg width="10" height="10" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
      <polyline points="14 2 14 8 20 8"/>
    </svg>
  ),
  Copy: () => (
    <svg width="11" height="11" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <rect x="9" y="9" width="13" height="13" rx="2"/>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
    </svg>
  ),
  Plus: () => (
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
  ),
  Link: () => (
    <svg width="10" height="10" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
      <polyline points="15 3 21 3 21 9"/>
      <line x1="10" y1="14" x2="21" y2="3"/>
    </svg>
  ),
  Warn: () => (
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
      <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
    </svg>
  ),
  Terminal: () => (
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <polyline points="4 17 10 11 4 5"/>
      <line x1="12" y1="19" x2="20" y2="19"/>
    </svg>
  ),
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REUSABLE COMPONENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function SevBadge({ sev }) {
  return (
    <span className={cx(`b-${sev}`,
      'inline-flex items-center px-[7px] py-[2px] rounded text-[9px] font-mono font-medium border tracking-[.1em] uppercase flex-shrink-0'
    )}>
      {sev}
    </span>
  );
}

function SrcTag({ src }) {
  const labels = {
    snyk_code:'Snyk Code', trivy:'Trivy', snyk_iac:'Snyk IAC',
    snyk_container:'Container', history_guard:'Git History',
    llm_only:'LLM', llm_enriched:'LLM+Tool',
  };
  return (
    <span className={cx(`s-${src}`, 'text-[9px] font-mono flex-shrink-0 tracking-wide')}>
      {labels[src] || src}
    </span>
  );
}

function PulseDots() {
  return (
    <span className="inline-flex gap-[3px] items-center ml-1">
      {[0,1,2].map(i => (
        <span
          key={i}
          className="w-[5px] h-[5px] rounded-full bg-cyan"
          style={{ animation:`blink 1.3s ease-in-out ${i*0.18}s infinite` }}
        />
      ))}
    </span>
  );
}

function ProgBar({ pct, phase }) {
  const phaseColor = {
    navigator:'#22d3ee', researcher:'#60a5fa', scanner:'#4ade80',
    analysis:'#c084fc', exploiter:'#fbbf24', auditor:'#4ade80', pipeline:'#22d3ee',
  };
  const col = phaseColor[phase] || '#22d3ee';
  return (
    <div className="prog-track w-full h-[6px]">
      <div
        className="prog-fill"
        style={{ width:`${pct}%`, background: col, boxShadow:`0 0 8px ${col}60` }}
      />
    </div>
  );
}

function PhaseTracker({ currentPhase }) {
  const curIdx = PHASES.findIndex(p => p.id === currentPhase);
  return (
    <div className="space-y-[3px]">
      {PHASES.map((ph, i) => {
        const done   = i < curIdx;
        const active = i === curIdx;
        const pend   = i > curIdx;
        return (
          <div
            key={ph.id}
            className={cx(
              'flex items-center gap-3 px-3 py-[10px] rounded-xl transition-all duration-300',
              active && 'bg-cyan/[.06] border border-cyan/20 phase-active',
              done   && 'opacity-50',
              pend   && 'opacity-20',
            )}
          >
            <div className={cx(
              'w-7 h-7 rounded-lg flex items-center justify-center text-[13px] flex-shrink-0',
              active && 'bg-cyan/15 text-cyan',
              done   && 'bg-lime/10 text-lime',
              pend   && 'bg-card text-ash',
            )}>
              {done ? <Ic.Check/> : ph.icon}
            </div>
            <div className="min-w-0 flex-1">
              <div className="flex items-center">
                <span className={cx(
                  'text-[11px] font-display font-700',
                  active && 'text-snow',
                  done   && 'text-lime',
                  pend   && 'text-ash',
                )}>
                  {ph.label}
                </span>
                {active && <PulseDots/>}
              </div>
              <p className="text-[9px] text-ash mt-[1px] leading-tight">{ph.note}</p>
            </div>
          </div>
        );
      })}
    </div>
  );
}

function Terminal({ logs }) {
  const endRef = useRef(null);
  useEffect(() => {
    if (endRef.current) {
      endRef.current.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }, [logs.length]);

  function colour(msg) {
    return msg
      .replace(/\[([A-Z_\.:\d]+)\]/g, (_,t) => `<span style="color:#60a5fa;opacity:.75">[${t}]</span>`)
      .replace(/(âœ…|âœ”)/g,   '<span style="color:#4ade80">$1</span>')
      .replace(/(âŒ|âœ—)/g,   '<span style="color:#f87171">$1</span>')
      .replace(/(âš |âš ï¸)/g,   '<span style="color:#fbbf24">$1</span>')
      .replace(/(ğŸ”|ğŸ”¬|ğŸ›¡|ğŸ§ |âš”|ğŸ“Š|ğŸš€|ğŸ“¡|ğŸ”—)/g, '<span style="opacity:.7">$1</span>');
  }

  function levelIcon(l) {
    if (l === 'ERROR')   return { icon:'âœ—', col:'#f87171' };
    if (l === 'WARNING') return { icon:'!', col:'#fbbf24' };
    return { icon:'â€º', col:'#4ade80' };
  }

  return (
    <div className="flex flex-col bg-pit border border-rim rounded-xl overflow-hidden flex-1 min-h-0">
      <div className="flex items-center gap-2 px-4 py-2 bg-well border-b border-rim flex-shrink-0">
        <div className="flex gap-[5px]">
          <span className="w-[10px] h-[10px] rounded-full bg-coral/60"/>
          <span className="w-[10px] h-[10px] rounded-full bg-gold/60"/>
          <span className="w-[10px] h-[10px] rounded-full bg-lime/60"/>
        </div>
        <span className="text-[10px] text-ash ml-2 flex items-center gap-1.5 font-mono">
          <Ic.Terminal/> pipeline output
        </span>
      </div>
      <div className="term term-scroll flex-1 p-4 space-y-[1px]">
        {logs.length === 0 && <span className="text-ash italic">Waiting for pipelineâ€¦</span>}
        {logs.map((line, i) => {
          const { icon, col } = levelIcon(line.level);
          return (
            <div key={i} className="flex gap-2 anim-fade">
              <span className="flex-shrink-0 select-none" style={{ color: col }}>{icon}</span>
              <span className="text-mist/85 break-all" dangerouslySetInnerHTML={{ __html: colour(line.msg) }} />
            </div>
          );
        })}
        <div ref={endRef}/>
      </div>
    </div>
  );
}

function LiveFeed({ findings }) {
  if (!findings.length) return null;
  const latest = [...findings].reverse().slice(0, 10);
  return (
    <div className="bg-card border border-rim rounded-xl p-4 flex flex-col h-[220px] flex-shrink-0 overflow-hidden">
      <div className="flex items-center justify-between mb-3 flex-shrink-0">
        <span className="text-[9px] text-ash uppercase tracking-[.15em]">Live findings stream</span>
        <span className="font-display font-700 text-snow text-sm">{findings.length}</span>
      </div>
      <div className="space-y-[6px] overflow-y-auto term-scroll flex-1 pr-1">
        {latest.map((f, i) => (
          <div key={i} className="flex items-center gap-2 anim-left">
            <SevBadge sev={f.severity}/>
            <span className="text-[11px] text-mist/80 truncate flex-1 font-mono">{f.title}</span>
            <SrcTag src={f.source}/>
          </div>
        ))}
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE: LANDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function LandingPage({ onStart }) {
  const [url,  setUrl]  = useState('');
  const [busy, setBusy] = useState(false);
  const [err,  setErr]  = useState('');
  const inputRef = useRef(null);

  useEffect(() => { inputRef.current?.focus(); }, []);

  async function submit(e) {
    e.preventDefault();
    const u = url.trim();
    if (!u)                    { setErr('Enter a GitHub repository URL'); return; }
    if (!u.startsWith('http')) { setErr('URL must start with https://'); return; }
    setBusy(true); setErr('');
    try {
      const res = await fetch(`${API}/scan`, {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ repo_url: u }),
      });
      const text = await res.text();
      let d = null;
      try { d = JSON.parse(text); } catch { }
      if (!res.ok) throw new Error(d?.error || `Server error ${res.status}`);
      onStart(d.scan_id, u);
    } catch (ex) {
      setErr(ex.message);
      setBusy(false);
    }
  }

  return (
    <div className="h-screen w-screen flex flex-col items-center justify-center grid-bg px-4 relative overflow-hidden">
      <div className="orb" style={{ width:700, height:700, top:'-240px', left:'-200px', background:'radial-gradient(circle, rgba(34,211,238,.06) 0%, transparent 65%)' }}/>
      <div className="orb" style={{ width:500, height:500, bottom:'-180px', right:'-160px', background:'radial-gradient(circle, rgba(192,132,252,.05) 0%, transparent 65%)' }}/>
      
      <div className="relative z-10 w-full max-w-[520px] anim-up">
        <div className="flex items-center gap-3 justify-center mb-10">
          <div className="w-11 h-11 rounded-2xl bg-cyan/10 border border-cyan/25 flex items-center justify-center text-cyan">
            <Ic.Shield/>
          </div>
          <div>
            <h1 className="font-display font-900 text-[22px] tracking-tight text-snow leading-none">SwiftAudit</h1>
            <p className="text-[9px] text-ash font-mono tracking-[.22em] uppercase mt-[2px]">AI Security Platform</p>
          </div>
          <span className="ml-auto text-[9px] font-mono text-cyan border border-cyan/25 bg-cyan/5 px-[10px] py-[5px] rounded-full">v10</span>
        </div>

        <div className="text-center mb-10">
          <h2 className="font-display font-900 leading-[1.08] mb-4 text-4xl lg:text-5xl">
            <span className="text-snow">Find vulnerabilities</span><br/>
            <span className="bg-gradient-to-r from-cyan to-lime bg-clip-text text-transparent">before attackers do</span>
          </h2>
          <p className="text-fog text-[12px] font-mono">Watch every step as it happens â€” nothing hidden.</p>
        </div>

        <div className="bg-card border border-rim rounded-2xl p-6 shadow-2xl">
          <form onSubmit={submit}>
            <label className="block text-[9px] font-mono text-ash uppercase tracking-[.18em] mb-2">GitHub repository URL</label>
            <div className="flex gap-2">
              <input ref={inputRef} type="text" value={url} onChange={e => { setUrl(e.target.value); setErr(''); }} placeholder="https://github.com/owner/repo" disabled={busy}
                className="flex-1 bg-well border border-rim rounded-xl px-4 py-[11px] text-[12px] font-mono text-snow focus:outline-none focus:border-cyan/40 transition disabled:opacity-50" />
              <button type="submit" disabled={busy || !url.trim()} className="btn-glow px-5 py-[11px] rounded-xl text-[13px] disabled:opacity-30">
                {busy ? <span className="flex items-center gap-2"><span className="w-3.5 h-3.5 spinner inline-block"/>Starting</span> : 'Analyse â†’'}
              </button>
            </div>
            {err && <div className="mt-3 flex items-center gap-2 text-coral text-[11px] font-mono anim-fade"><Ic.Warn/> {err}</div>}
          </form>
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE: SCANNING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function ScanningPage({ scanId, repoUrl, onComplete }) {
  const [pct,      setPct]      = useState(5);
  const [phase,    setPhase]    = useState('navigator');
  const [step,     setStep]     = useState('Initialisingâ€¦');
  const [logs,     setLogs]     = useState([]);
  const [findings, setFindings] = useState([]);
  const [errMsg,   setErrMsg]   = useState('');

  const addLog = useCallback((msg, level = 'INFO') => {
    setLogs(prev => {
      const next = [...prev, { msg, level, ts: Date.now() }];
      return next.length > 400 ? next.slice(-400) : next;
    });
  }, []);

  useEffect(() => {
    const es = new EventSource(`${API}/scan/${scanId}/stream`);
    es.addEventListener('progress', e => {
      const d = JSON.parse(e.data);
      setPct(d.pct || 0);
      setPhase(d.phase || 'pipeline');
      setStep(d.step || '');
      if (d.step) addLog(`[${(d.phase||'PIPE').toUpperCase()}] ${d.step}`);
    });
    es.addEventListener('log', e => {
      const d = JSON.parse(e.data);
      addLog(d.message, d.level || 'INFO');
    });
    es.addEventListener('finding', e => {
      const d = JSON.parse(e.data);
      setFindings(prev => [...prev, d]);
    });
    es.addEventListener('complete', e => {
      setPct(100);
      es.close();
      setTimeout(() => onComplete(scanId), 1200);
    });
    es.addEventListener('error', e => {
      if (e.data) {
        const d = JSON.parse(e.data);
        setErrMsg(d.message);
      }
      es.close();
    });
    return () => es.close();
  }, [scanId]);

  return (
    <div className="h-screen w-screen bg-ink overflow-hidden flex flex-col">
      <div className="orb" style={{ width:700, height:700, top:'-200px', right:'-200px', background:'radial-gradient(circle, rgba(34,211,238,.055) 0%, transparent 65%)' }}/>
      
      <header className="px-6 py-4 border-b border-rim flex items-center justify-between z-10 flex-shrink-0">
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 rounded-xl bg-cyan/10 border border-cyan/20 flex items-center justify-center text-cyan"><Ic.Shield/></div>
          <div>
            <p className="font-display font-800 text-[13px] text-snow leading-none">SwiftAudit</p>
            <p className="text-[10px] font-mono text-fog mt-1 truncate max-w-[200px]">{repoUrl.split('/').slice(-2).join('/')}</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <span className="w-2 h-2 rounded-full bg-cyan animate-pulse"/>
          <span className="text-[11px] font-mono text-cyan tracking-widest uppercase">System Scanning</span>
        </div>
      </header>

      <main className="flex-1 flex flex-col p-6 gap-6 min-h-0 z-10">
        <div className="flex-shrink-0">
          <div className="flex items-center justify-between mb-2">
            <span className="text-[11px] font-mono text-fog truncate">{step}</span>
            <span className="text-[13px] font-display font-700 text-snow">{pct}%</span>
          </div>
          <ProgBar pct={pct} phase={phase}/>
        </div>

        <div className="flex-1 flex gap-6 min-h-0">
          <aside className="w-64 flex flex-col gap-6">
            <div className="flex-1 overflow-y-auto pr-2 term-scroll">
              <p className="text-[9px] text-ash uppercase tracking-[.15em] mb-3">Pipeline stages</p>
              <PhaseTracker currentPhase={phase}/>
            </div>
            <div className="grid grid-cols-2 gap-2">
              {[ { label:'Findings', val: findings.length, col:'#e8eef8' }, { label:'Done', val: `${pct}%`, col:'#22d3ee' } ].map(t => (
                <div key={t.label} className="bg-card border border-rim rounded-xl p-3">
                  <p className="text-[9px] font-mono text-ash uppercase tracking-wide mb-1">{t.label}</p>
                  <p className="text-xl font-display font-800 leading-none" style={{ color: t.col }}>{t.val}</p>
                </div>
              ))}
            </div>
          </aside>

          <section className="flex-1 flex flex-col gap-6 min-h-0">
            <Terminal logs={logs}/>
            <LiveFeed findings={findings}/>
          </section>
        </div>
      </main>

      {errMsg && (
        <div className="fixed bottom-6 right-6 z-50 bg-pit border border-coral/30 rounded-xl px-5 py-4 flex gap-3 items-start shadow-2xl max-w-md anim-up">
          <span className="text-coral mt-1"><Ic.Warn/></span>
          <p className="text-[11px] font-mono text-coral leading-relaxed">{errMsg}</p>
        </div>
      )}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULTS SUB-COMPONENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function GradeRing({ grade, score }) {
  const col = GRADE_COL[grade] || '#8492a6';
  const deg = ((score || 0) / 100) * 360;
  return (
    <div className="flex flex-col items-center gap-2">
      <div className="w-[80px] h-[80px] rounded-full p-[4px]" style={{ background:`conic-gradient(${col} 0deg ${deg}deg, #1e2638 ${deg}deg 360deg)` }}>
        <div className="w-full h-full rounded-full bg-card flex flex-col items-center justify-center">
          <span className="font-display font-900 text-2xl" style={{ color:col }}>{grade}</span>
          <span className="text-[8px] font-mono text-ash">{score}/100</span>
        </div>
      </div>
      <span className="text-[9px] font-mono text-ash tracking-widest uppercase">Risk Grade</span>
    </div>
  );
}

function StatTile({ label, value, color }) {
  return (
    <div className="bg-card border border-rim rounded-xl p-4 min-w-[100px] flex-1">
      <p className="text-[9px] font-mono text-ash uppercase tracking-tighter mb-1">{label}</p>
      <p className="font-display font-800 text-2xl" style={{ color }}>{num(value)}</p>
    </div>
  );
}

function SevBars({ findings }) {
  const counts = { CRITICAL:0, HIGH:0, MEDIUM:0, LOW:0, INFO:0 };
  (findings || []).forEach(f => { counts[f.severity] = (counts[f.severity]||0) + 1; });
  const max = Math.max(...Object.values(counts), 1);
  return (
    <div className="bg-card border border-rim rounded-xl p-5 flex-1">
      <p className="text-[9px] font-mono text-ash uppercase tracking-widest mb-4">Severity breakdown</p>
      <div className="space-y-[10px]">
        {Object.entries(counts).map(([sev, cnt]) => (
          <div key={sev} className="flex items-center gap-3">
            <span className="text-[9px] font-mono text-fog w-14 text-right uppercase">{sev}</span>
            <div className="flex-1 bg-well rounded-md h-[14px] overflow-hidden">
              <div className="h-full rounded-md bar-fill" style={{ width: `${(cnt/max)*100}%`, background: SEV_COLOR[sev], opacity: cnt === 0 ? .1 : 1 }} />
            </div>
            <span className="text-[10px] font-mono w-4 text-right" style={{ color: SEV_COLOR[sev] }}>{cnt}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

function Radar({ scores }) {
  if (!scores) return null;
  const axes = [ { key:'authentication', label:'Auth' }, { key:'input_validation', label:'Input' }, { key:'secrets_management',label:'Secrets' }, { key:'api_security', label:'API' }, { key:'dependency_safety', label:'Deps' }, { key:'configuration', label:'Config' } ];
  const N=6, R=60, cx=100, cy=100;
  const pt = (i, v) => {
    const a = (Math.PI*2*i/N) - Math.PI/2;
    const r = (v/100)*R;
    return [cx + r*Math.cos(a), cy + r*Math.sin(a)];
  };
  const lp = i => {
    const a = (Math.PI*2*i/N) - Math.PI/2;
    return [cx + (R+18)*Math.cos(a), cy + (R+18)*Math.sin(a)];
  };
  const poly = axes.map((a,i) => pt(i, scores[a.key]??100).join(',')).join(' ');
  return (
    <div className="bg-card border border-rim rounded-xl p-5 w-full md:w-64 flex flex-col">
      <p className="text-[9px] font-mono text-ash uppercase tracking-widest mb-4">Security radar</p>
      <svg viewBox="0 0 200 200" className="w-full max-w-[160px] mx-auto flex-1">
        {[25,50,75,100].map(g => <polygon key={g} className="radar-grid" points={axes.map((_,i) => pt(i,g).join(',')).join(' ')}/>)}
        {axes.map((_,i) => { const [x,y] = pt(i,100); return <line key={i} x1={cx} y1={cy} x2={x} y2={y} className="radar-grid"/>; })}
        <polygon className="radar-poly" points={poly}/>
        {axes.map((a,i) => { const [lx,ly] = lp(i); return <text key={a.key} x={lx} y={ly} textAnchor="middle" dominantBaseline="middle" fontSize="9" fill="#8492a6" fontFamily="DM Mono">{a.label}</text>; })}
      </svg>
    </div>
  );
}

function FindingCard({ f, i }) {
  const [open, setOpen] = useState(false);
  return (
    <div className="fcard bg-card border border-rim rounded-xl overflow-hidden anim-fade" style={{ animationDelay:`${Math.min(i*.02, .4)}s` }}>
      <div className="flex items-center gap-2.5 px-4 py-3" onClick={() => setOpen(!open)}>
        <SevBadge sev={f.severity}/>
        <span className="text-[12px] font-mono text-mist flex-1 truncate">{f.title}</span>
        <SrcTag src={f.detection_source}/>
        <span className="ml-1.5 text-ash">{open ? <Ic.ChevDown/> : <Ic.ChevRight/>}</span>
      </div>
      <div className={cx('expand', open && 'open')}>
        <div>
          <div className="border-t border-rim px-4 py-4 space-y-4">
            <div className="flex flex-wrap gap-x-5 gap-y-1 text-[10px] font-mono text-fog">
              {f.file_path && <span className="flex items-center gap-[5px]"><Ic.File/><span className="text-sky">{f.file_path}</span>{f.line_number && <span className="text-ash">:{f.line_number}</span>}</span>}
              {f.cwe_id && <span className="text-mauve">{f.cwe_id}</span>}
              {f.category && <span className="text-ash/80">{f.category}</span>}
            </div>
            {f.description && <p className="text-[12px] text-mist/80 leading-relaxed">{f.description}</p>}
            {f.code_snippet && (
              <pre className="bg-pit rounded-lg px-4 py-3 text-[11px] font-mono text-lime/80 overflow-x-auto whitespace-pre-wrap">{f.code_snippet}</pre>
            )}
            {f.patch_explanation && (
              <div className="bg-lime/[.05] border border-lime/20 rounded-lg p-3.5">
                <p className="text-[9px] font-mono text-lime uppercase mb-1.5 font-bold tracking-widest">Remediation Guidance</p>
                <p className="text-[12px] text-mist/80 italic">{f.patch_explanation}</p>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE: RESULTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function ResultsPage({ scanId, onNewScan }) {
  const [result,  setResult]  = useState(null);
  const [loading, setLoading] = useState(true);
  const [sevFilt, setSevFilt] = useState('ALL');
  const [search,  setSearch]  = useState('');

  useEffect(() => {
    fetch(`${API}/scan/${scanId}/result`)
      .then(r => r.json())
      .then(d => { setResult(d); setLoading(false); })
      .catch(() => setLoading(false));
  }, [scanId]);

  const filtered = useMemo(() => {
    if (!result?.findings) return [];
    let f = result.findings;
    if (sevFilt !== 'ALL') f = f.filter(x => x.severity === sevFilt);
    if (search) {
      const q = search.toLowerCase();
      f = f.filter(x => (x.title||'').toLowerCase().includes(q) || (x.file_path||'').toLowerCase().includes(q));
    }
    return [...f].sort((a,b) => (SEV_RANK[a.severity]??9)-(SEV_RANK[b.severity]??9));
  }, [result, sevFilt, search]);

  if (loading) return <div className="h-screen bg-ink flex items-center justify-center"><div className="spinner w-8 h-8"/></div>;

  const pdfFilename = result.report_pdf_path ? result.report_pdf_path.split(/[\\/]/).pop() : null;

  return (
    <div className="h-screen w-screen bg-ink flex flex-col overflow-hidden">
      {/* Fixed Sticky Header */}
      <nav className="bg-ink border-b border-rim flex-shrink-0 z-50">
        <div className="max-w-7xl mx-auto px-5 py-3 flex items-center justify-between">
          <div className="flex items-center gap-2.5">
            <div className="w-8 h-8 rounded-xl bg-cyan/10 border border-cyan/25 flex items-center justify-center text-cyan"><Ic.Shield/></div>
            <span className="font-display font-800 text-[14px] text-snow uppercase tracking-tighter">SwiftAudit <span className="text-ash ml-2 text-[10px] font-mono">/ VAULT</span></span>
          </div>
          
          <div className="flex items-center gap-3">
            {/* DOWNLOAD BUTTON */}
            {pdfFilename && (
              <a href={`/reports/${pdfFilename}`} target="_blank" className="flex items-center gap-1.5 text-[11px] font-mono text-lime border border-lime/30 bg-lime/5 px-3 py-1.5 rounded-lg hover:bg-lime/10 transition-colors">
                <Ic.File/> Download PDF
              </a>
            )}
            <button onClick={onNewScan} className="flex items-center gap-1.5 text-[11px] font-mono text-cyan border border-cyan/30 bg-cyan/5 px-3 py-1.5 rounded-lg hover:bg-cyan/10 transition-colors"><Ic.Plus/> New scan</button>
          </div>
        </div>
      </nav>

      {/* Main content scroll container */}
      <div className="flex-1 overflow-y-auto term-scroll">
        <div className="max-w-7xl mx-auto px-5 py-8">
          
          {/* Top Score Row */}
          <div className="flex flex-col lg:flex-row gap-4 mb-8">
             <div className="flex gap-4 items-center bg-card border border-rim p-6 rounded-2xl">
                <GradeRing grade={result.risk_grade} score={result.overall_risk_score}/>
                <div className="space-y-1">
                   <p className="text-[10px] font-mono text-ash uppercase tracking-widest leading-none">Overall Risk Profile</p>
                   <p className="text-sm text-fog max-w-xs leading-relaxed italic">Repository security has been calculated based on findings severity and frequency.</p>
                </div>
             </div>
             
             <div className="flex flex-wrap gap-2 flex-1">
                <StatTile label="Total"    value={result.findings_count} color="#e8eef8"/>
                <StatTile label="Critical" value={result.critical_count}  color="#f87171"/>
                <StatTile label="High"     value={result.high_count}      color="#fbbf24"/>
                <StatTile label="Tool"     value={result.tool_finding_count} color="#4ade80"/>
                <StatTile label="LLM"      value={result.llm_finding_count} color="#c084fc"/>
             </div>
          </div>

          {/* Executive Summary */}
          <div className="bg-card border border-rim rounded-2xl p-6 mb-8 anim-up">
              <p className="text-[9px] font-mono text-ash uppercase tracking-widest mb-3 border-b border-rim pb-2 flex items-center gap-2">
                <Ic.Shield/> Executive Audit Synthesis
              </p>
              <div className="text-[13px] text-mist/85 leading-relaxed whitespace-pre-line font-mono italic">
                {result.summary || "Security analysis successfully synthesized. No critical logic block failures detected."}
              </div>
          </div>

          {/* Visualization Row */}
          <div className="flex flex-col md:flex-row gap-6 mb-10">
             <SevBars findings={result.findings}/>
             <Radar scores={result.radar_scores}/>
          </div>

          {/* Findings Toolbar */}
          <div className="sticky top-0 z-40 bg-ink pt-2 pb-4 mb-4 border-b border-rim/50 flex items-center gap-4 flex-wrap">
            <h2 className="font-display font-800 text-lg text-snow">Findings <span className="text-ash font-mono text-xs ml-1">({filtered.length})</span></h2>
            <div className="flex gap-1">
              {['ALL','CRITICAL','HIGH','MEDIUM','LOW','INFO'].map(s => (
                <button key={s} onClick={() => setSevFilt(s)} className={cx('text-[9px] font-mono px-2 py-1 rounded border transition-all', sevFilt===s ? 'border-cyan/40 bg-cyan/10 text-cyan' : 'border-rim bg-card text-ash hover:text-fog')}>{s}</button>
              ))}
            </div>
            <div className="flex-1 min-w-[200px] relative">
              <span className="absolute left-2.5 top-1/2 -translate-y-1/2 text-ash"><Ic.Search/></span>
              <input type="text" value={search} onChange={e => setSearch(e.target.value)} placeholder="Search findingsâ€¦" className="w-full bg-card border border-rim rounded-lg pl-7 pr-3 py-1.5 text-[11px] font-mono text-snow focus:outline-none focus:border-cyan/40 shadow-inner"/>
            </div>
          </div>

          {/* Findings List */}
          <div className="space-y-2 pb-20">
            {filtered.map((f, i) => <FindingCard key={i} f={f} i={i}/>)}
            {filtered.length === 0 && <div className="text-center py-20 text-ash font-mono border border-dashed border-rim rounded-2xl bg-well/20">No findings match the current filters.</div>}
          </div>
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOT APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function App() {
  const [view,   setView]   = useState('landing');
  const [scanId, setScanId] = useState('');
  const [repo,   setRepo]   = useState('');

  function handleStart(id, url) { setScanId(id); setRepo(url); setView('scanning'); }
  function handleComplete() { setView('results'); }
  function handleNewScan() { setView('landing'); setScanId(''); setRepo(''); }

  if (view === 'landing')  return <LandingPage onStart={handleStart}/>;
  if (view === 'scanning') return <ScanningPage scanId={scanId} repoUrl={repo} onComplete={handleComplete}/>;
  if (view === 'results')  return <ResultsPage  scanId={scanId} onNewScan={handleNewScan}/>;
  return null;
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
{% endraw %}
</script>
</body>
</html>